"""
Servidor de agente de carreira usando python_a2a.
Integra as funcionalidades de IA para an√°lise de perfil, gera√ß√£o de trilhas e sugest√µes.
"""

import asyncio
import json
import logging

from python_a2a import (
    A2AServer,
    Message,
    MessageRole,
    TextContent,
    agent,
    run_server,
    skill,
)

from app.agent import (
    analisar_perfil_ia,
    create_career_agent,
    gerar_trilha_ia,
    sugerir_recursos_ia,
    run_career_agent_sync,
    run_llm_sync,
)
from app.models import Competencia, ObjetivoCarreira, PerfilPessoa
from prompts import CareerPrompts

# Configurar logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


@agent(
    name="Agente de Carreira AI",
    description="Especialista em desenvolvimento de carreira e educa√ß√£o profissional",
    version="1.0.0",
)
class CareerAgent(A2AServer):
    """Agente de carreira com capacidades de IA para an√°lise e recomenda√ß√µes."""

    def __init__(self):
        super().__init__()
        self.career_agent = None
        self._initialize_agent()

    def _initialize_agent(self):
        """Inicializa o agente de carreira IA."""
        try:
            self.career_agent = create_career_agent()
            if self.career_agent:
                logger.info("Agente de carreira IA inicializado com sucesso")
            else:
                logger.warning("Agente de carreira IA n√£o p√¥de ser inicializado")
        except Exception as e:
            logger.error(f"Erro ao inicializar agente IA: {e}")

    @skill(
        name="Analisar Perfil",
        description="Analisa um perfil profissional e fornece insights detalhados",
        tags=["an√°lise", "perfil", "carreira"],
    )
    async def analisar_perfil(self, perfil_data: str) -> str:
        """
        Analisa um perfil profissional.

        Args:
            perfil_data: JSON string com dados do perfil

        Returns:
            An√°lise detalhada do perfil
        """
        try:
            perfil_dict = json.loads(perfil_data)
            perfil = PerfilPessoa(**perfil_dict)
            resultado = await analisar_perfil_ia(perfil, self.career_agent)
            return resultado
        except json.JSONDecodeError:
            return "Erro: Formato JSON inv√°lido para o perfil."
        except Exception as e:
            logger.error(f"Erro ao analisar perfil: {e}")
            return f"Erro ao analisar perfil: {str(e)}"

    @skill(
        name="Gerar Trilha de Estudos",
        description="Gera uma trilha de estudos personalizada baseada no perfil",
        tags=["trilha", "estudos", "educa√ß√£o", "desenvolvimento"],
    )
    async def gerar_trilha(self, perfil_data: str) -> str:
        """
        Gera uma trilha de estudos personalizada.

        Args:
            perfil_data: JSON string com dados do perfil

        Returns:
            Trilha de estudos estruturada
        """
        try:
            perfil_dict = json.loads(perfil_data)
            perfil = PerfilPessoa(**perfil_dict)
            trilha = await gerar_trilha_ia(perfil, self.career_agent)
            return trilha
        except json.JSONDecodeError:
            return "Erro: Formato JSON inv√°lido para o perfil."
        except Exception as e:
            logger.error(f"Erro ao gerar trilha: {e}")
            return f"Erro ao gerar trilha: {str(e)}"

    @skill(
        name="Sugerir Recursos",
        description="Sugere recursos de estudo para uma √°rea espec√≠fica",
        tags=["recursos", "cursos", "certifica√ß√µes", "estudo"],
    )
    async def sugerir_recursos(
        self, area: str, nivel: str = "intermedi√°rio", tipo: str = "todos"
    ) -> str:
        """
        Sugere recursos de estudo para uma √°rea.

        Args:
            area: √Årea de interesse
            nivel: N√≠vel de conhecimento (iniciante, intermedi√°rio, avan√ßado)
            tipo: Tipo de recurso (cursos, livros, certifica√ß√µes, todos)

        Returns:
            Lista de recursos sugeridos
        """
        try:
            recursos = await sugerir_recursos_ia(area, nivel, tipo, self.career_agent)
            return recursos
        except Exception as e:
            logger.error(f"Erro ao sugerir recursos: {e}")
            return f"Erro ao sugerir recursos: {str(e)}"

    @skill(
        name="Criar Perfil Exemplo",
        description="Cria um exemplo de perfil para testes",
        tags=["exemplo", "template", "perfil"],
    )
    def criar_perfil_exemplo(self) -> str:
        """
        Cria um exemplo de perfil para demonstra√ß√£o.

        Returns:
            JSON string com exemplo de perfil
        """
        perfil_exemplo = PerfilPessoa(
            nome="Jo√£o Silva",
            idade=28,
            escolaridade="Superior Completo",
            area_formacao="Engenharia da Computa√ß√£o",
            competencias_atuais=[
                Competencia(
                    area="Python",
                    nivel="intermedi√°rio",
                    experiencia_anos=3,
                    detalhes="Desenvolvimento web e automa√ß√£o",
                ),
                Competencia(
                    area="JavaScript",
                    nivel="b√°sico",
                    experiencia_anos=1,
                    detalhes="Frontend b√°sico",
                ),
            ],
            objetivos_carreira=[
                ObjetivoCarreira(
                    cargo_desejado="Cientista de Dados",
                    area_interesse="Intelig√™ncia Artificial",
                    prazo_anos=2,
                    motivacao="Interesse em machine learning e big data",
                )
            ],
            disponibilidade_estudo_horas_semana=15,
            preferencia_aprendizado="online",
            recursos_disponiveis="cursos online, livros",
        )
        return perfil_exemplo.model_dump_json(indent=2, ensure_ascii=False)

    def _processar_analise_perfil_sync(self, message: Message) -> Message:
        """Processa solicita√ß√µes de an√°lise de perfil de forma s√≠ncrona."""
        try:
            text = message.content.text
            if "{" in text and "}" in text:
                start = text.find("{")
                end = text.rfind("}") + 1
                perfil_json = text[start:end]
                perfil_dict = json.loads(perfil_json)
                perfil = PerfilPessoa(**perfil_dict)

                prompt = CareerPrompts.profile_analysis_prompt(perfil.model_dump())

                if self.career_agent:
                    resultado = run_career_agent_sync(self.career_agent, prompt)
                else:
                    resultado = run_llm_sync(prompt)

                return Message(
                    content=TextContent(
                        text=f"üìä **An√°lise do Perfil:**\n\n{resultado}"
                    ),
                    role=MessageRole.AGENT,
                    parent_message_id=message.message_id,
                    conversation_id=message.conversation_id,
                )
            else:
                return Message(
                    content=TextContent(
                        text="Para analisar um perfil, envie os dados no formato JSON. Use 'exemplo' para ver um template."
                    ),
                    role=MessageRole.AGENT,
                    parent_message_id=message.message_id,
                    conversation_id=message.conversation_id,
                )
        except Exception as e:
            return Message(
                content=TextContent(text=f"Erro ao processar an√°lise: {str(e)}"),
                role=MessageRole.AGENT,
                parent_message_id=message.message_id,
                conversation_id=message.conversation_id,
            )

    def _processar_trilha_estudos_sync(self, message: Message) -> Message:
        """Processa solicita√ß√µes de trilha de estudos de forma s√≠ncrona."""
        try:
            text = message.content.text
            if "{" in text and "}" in text:
                start = text.find("{")
                end = text.rfind("}") + 1
                perfil_json = text[start:end]
                perfil_dict = json.loads(perfil_json)
                perfil = PerfilPessoa(**perfil_dict)

                prompt = CareerPrompts.study_trail_prompt(perfil.model_dump())

                if self.career_agent:
                    resultado = run_career_agent_sync(self.career_agent, prompt)
                else:
                    resultado = run_llm_sync(prompt)

                return Message(
                    content=TextContent(
                        text=f"üõ§Ô∏è **Trilha de Estudos:**\n\n{resultado}"
                    ),
                    role=MessageRole.AGENT,
                    parent_message_id=message.message_id,
                    conversation_id=message.conversation_id,
                )
            else:
                return Message(
                    content=TextContent(
                        text="Para gerar uma trilha de estudos, envie os dados do perfil no formato JSON. Use 'exemplo' para ver um template."
                    ),
                    role=MessageRole.AGENT,
                    parent_message_id=message.message_id,
                    conversation_id=message.conversation_id,
                )
        except Exception as e:
            return Message(
                content=TextContent(text=f"Erro ao processar trilha: {str(e)}"),
                role=MessageRole.AGENT,
                parent_message_id=message.message_id,
                conversation_id=message.conversation_id,
            )

    def _processar_sugestao_recursos_sync(self, message: Message) -> Message:
        """Processa solicita√ß√µes de sugest√£o de recursos de forma s√≠ncrona."""
        try:
            text = message.content.text
            area, nivel, tipo = "tecnologia", "intermedi√°rio", "todos"

            if "√°rea:" in text or "area:" in text:
                area = text.split("√°rea:" if "√°rea:" in text else "area:")[1].split()[0].strip(",.")
            if "n√≠vel:" in text or "nivel:" in text:
                nivel = text.split("n√≠vel:" if "n√≠vel:" in text else "nivel:")[1].split()[0].strip(",.")
            if "tipo:" in text:
                tipo = text.split("tipo:")[1].split()[0].strip(",.")

            prompt = CareerPrompts.resource_suggestion_prompt(area, nivel, tipo)

            if self.career_agent:
                resultado = run_career_agent_sync(self.career_agent, prompt)
            else:
                resultado = run_llm_sync(prompt)

            return Message(
                content=TextContent(
                    text=f"üìö **Recursos para {area} (n√≠vel {nivel}):**\n\n{resultado}"
                ),
                role=MessageRole.AGENT,
                parent_message_id=message.message_id,
                conversation_id=message.conversation_id,
            )
        except Exception as e:
            return Message(
                content=TextContent(text=f"Erro ao sugerir recursos: {str(e)}"),
                role=MessageRole.AGENT,
                parent_message_id=message.message_id,
                conversation_id=message.conversation_id,
            )

    def handle_message(self, message: Message) -> Message:
        """Processa mensagens de forma s√≠ncrona."""
        try:
            if message.content.type != "text":
                return Message(
                    content=TextContent(text="Apenas mensagens de texto s√£o suportadas."),
                    role=MessageRole.AGENT,
                    parent_message_id=message.message_id,
                    conversation_id=message.conversation_id,
                )

            text = message.content.text.lower()

            if any(palavra in text for palavra in ["analisar", "an√°lise", "perfil"]):
                return self._processar_analise_perfil_sync(message)
            elif any(palavra in text for palavra in ["trilha", "estudos", "plano", "roadmap"]):
                return self._processar_trilha_estudos_sync(message)
            elif any(palavra in text for palavra in ["recursos", "cursos", "certifica√ß√£o", "sugerir"]):
                return self._processar_sugestao_recursos_sync(message)
            elif any(palavra in text for palavra in ["exemplo", "template", "demo"]):
                exemplo = self.criar_perfil_exemplo()
                return Message(
                    content=TextContent(text=f"Aqui est√° um exemplo de perfil:\n\n```json\n{exemplo}\n```"),
                    role=MessageRole.AGENT,
                    parent_message_id=message.message_id,
                    conversation_id=message.conversation_id,
                )
            elif any(palavra in text for palavra in ["ajuda", "help", "comandos"]):
                return self._gerar_ajuda(message)
            else:
                return self._gerar_resposta_padrao(message)
        except Exception as e:
            logger.error(f"Erro ao processar mensagem: {e}")
            return Message(
                content=TextContent(text=f"Erro interno: {str(e)}"),
                role=MessageRole.AGENT,
                parent_message_id=message.message_id,
                conversation_id=message.conversation_id,
            )

    def _gerar_ajuda(self, message: Message) -> Message:
        """Gera mensagem de ajuda."""
        ajuda = """
ü§ñ **Agente de Carreira AI** - Como posso ajudar:

**üìä An√°lise de Perfil:**
- Digite "analisar perfil" + dados JSON
- Receba insights sobre pontos fortes, √°reas de melhoria e recomenda√ß√µes

**üõ§Ô∏è Trilha de Estudos:**
- Digite "trilha de estudos" + dados JSON
- Receba um plano personalizado de desenvolvimento

**üìö Sugest√£o de Recursos:**
- Digite "sugerir recursos √°rea: [√°rea] n√≠vel: [n√≠vel] tipo: [tipo]"
- Receba cursos, livros, certifica√ß√µes e projetos recomendados

**üìù Exemplo de Perfil:**
- Digite "exemplo" para ver um template de perfil JSON

**üí° Dicas:**
- Use dados estruturados em JSON para melhores resultados
- Especifique suas compet√™ncias atuais e objetivos de carreira
- Inclua disponibilidade de tempo e recursos

Digite 'exemplo' para come√ßar!
"""
        return Message(
            content=TextContent(text=ajuda),
            role=MessageRole.AGENT,
            parent_message_id=message.message_id,
            conversation_id=message.conversation_id,
        )

    def _gerar_resposta_padrao(self, message: Message) -> Message:
        """Gera resposta padr√£o para mensagens n√£o reconhecidas."""
        resposta = """
üëã Ol√°! Sou seu **Agente de Carreira AI**.

Posso ajudar voc√™ com:
- üìä An√°lise de perfil profissional
- üõ§Ô∏è Cria√ß√£o de trilhas de estudos personalizadas
- üìö Sugest√£o de recursos educacionais
- üí° Orienta√ß√£o de carreira

Digite 'ajuda' para ver todos os comandos dispon√≠veis ou 'exemplo' para ver um template de perfil.

Como posso ajudar voc√™ hoje?
"""
        return Message(
            content=TextContent(text=resposta),
            role=MessageRole.AGENT,
            parent_message_id=message.message_id,
            conversation_id=message.conversation_id,
        )


if __name__ == "__main__":
    career_agent = CareerAgent()
    logger.info("Iniciando Agente de Carreira AI em http://0.0.0.0:5000")
    run_server(career_agent, host="0.0.0.0", port=5000)